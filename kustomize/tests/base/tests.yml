apiVersion: batch/v1
kind: Job
metadata:
  name: saksbehandling-funksjonelle-tester
spec:
  backoffLimit: 2
  template:
    spec:
      imagePullSecrets:
        - name: gpr-credentials
      serviceAccountName: default
      restartPolicy: Never
      initContainers:
        - name: vks-init
          image: navikt/vault-sidekick:v0.3.10-d122b16
          resources:
            limits:
              cpu: "1"
              memory: "1024Mi"
            requests:
              cpu: "0.5"
              memory: "512Mi"
          args:
          - -v=10
          - -logtostderr
          - -vault=https://vault.adeo.no
          - -one-shot
          - -cn=secret:serviceuser/data/dev/srvdp-funk-test:dir=/var/run/secrets/nais.io/service_user,fmt=flatten
          env:
          - name: VAULT_AUTH_METHOD
            value: kubernetes
          - name: VAULT_SIDEKICK_ROLE
            value: dp-saksbehandling-funksjonelle-tester
          - name: VAULT_K8S_LOGIN_PATH
            value: auth/kubernetes/preprod/fss/login
          volumeMounts:
          - mountPath: /var/run/secrets/nais.io/vault
            name: vault-secrets
            subPath: subpath/var/run/secrets/nais.io/vault
          - mountPath: /var/run/secrets/nais.io/service_user
            name: vault-secrets
            subPath: subpath/var/run/secrets/nais.io/service_user
      containers:
        - name: dp-saksbehandling-funksjonelle-tester
          resources:
            limits:
              cpu: "1"
              memory: "1024Mi"
            requests:
              cpu: "0.5"
              memory: "512Mi"
          env:
          - name: CUCUMBER_ENV
            value: dev
          - name: NAV_TRUSTSTORE_PATH
            value: /etc/ssl/certs/java/cacerts
          - name: NAV_TRUSTSTORE_PASSWORD
            value: changeme
          image:  docker.pkg.github.com/navikt/dp-saksbehandling-funksjonelle-tester/dp-saksbehandling-funksjonelle-tester:latest
          imagePullPolicy: Always
          volumeMounts:
          - mountPath: /etc/ssl/certs/ca-certificates.crt
            name: ca-bundle
            subPath: ca-bundle.pem
          - mountPath: /etc/pki/tls/certs/ca-bundle.crt
            name: ca-bundle
            subPath: ca-bundle.pem
          - mountPath: /etc/ssl/ca-bundle.pem
            name: ca-bundle
            subPath: ca-bundle.pem
          - mountPath: /etc/pki/tls/cacert.pem
            name: ca-bundle
            subPath: ca-bundle.pem
          - mountPath: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
            name: ca-bundle
            subPath: ca-bundle.pem
          - mountPath: /etc/ssl/certs/java/cacerts
            name: ca-bundle
            subPath: ca-bundle.jks
          - mountPath: /var/run/secrets/nais.io/vault/
            name: vault-secrets
            subPath: subpath/var/run/secrets/nais.io/vault
          - mountPath: /var/run/secrets/nais.io/service_user
            name: vault-secrets
            subPath: subpath/var/run/secrets/nais.io/service_user
      volumes:
      - name: vault-volume
        emptyDir:
          medium: Memory
      - name: ca-bundle
        configMap:
          defaultMode: 420
          name: ca-bundle
